<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="../static/index.css">
        <title>Taipei Trip 台北一日遊</title>
    </head>
    <body>
        <div class="navigation__background">
            <div class="navigation">
                <a href="/"><div class="navigation__title">台北一日遊</div></a>
                <div class="navigation__menu">
                    <button class="navigation__button">預定行程</button>
                    <button class="navigation__button" onclick="toggleSigninSignup()">登入/註冊</button>
                </div>
            </div>
        </div>
        <div class="hero_section">
            <div class="slogan">
                <div class="slogan__title">輕鬆享受台北一日悠閒</div>
                <div class="slogan__body">探索每個角落，體驗城市的深度旅遊行程</div>
                <form class="search_bar">
                    <input class="search_bar__box" type="text" placeholder="輸入景點名稱查詢">
                    <button class="search_bar__button"><img class="search_bar__icon" src="../static/search_icon.png"></button>
                </form>
            </div>
        </div>
        <div class="list_bar">
            <button class="list_bar__left_arrow"></button>
            <div class="container"></div>
            <button class="list_bar__right_arrow"></button>
        </div>
        <div class="attractions"></div>
        <div class="footer">COPYRIGHT © 2021 台北一日遊</div>
        <div class="member__background member--hide"></div>
        <div class="member__container member--hide">
            <div class="member__decorator_bar"></div>
            <div class="member__title"></div>
            <div class="member__close_icon" onclick="closeSigninSignup()"></div>
            <div id="signin_item" class="member--hide">
                <form id="signin_form" method="put" action="/api/user/auth">
                    <input class="member__input" type="text" name="email" placeholder="輸入電子信箱" required>
                    <input class="member__input" type="password" name="password" placeholder="輸入密碼" required>
                    <input class="member__submit" type="submit" value="登入帳戶">
                </form>
                <div class="member__text--normal" id="signin_text">
                    <div class="member__text--error"></div>
                    <span>還沒有帳戶？</span>
                    <span class="member__text--pointer" onclick="signupPage(); return false">點此註冊</span>
                </div>
            </div>
            
            <div id="signup_item" class="member--hide">
                <form id="signup_form" method="post" action="/api/user">
                    <input class="member__input" type="text" name="name" placeholder="輸入姓名" required>
                    <input class="member__input" type="text" name="email" placeholder="輸入電子信箱" required>
                    <input class="member__input" type="password" name="password" placeholder="輸入密碼" required>
                    <input class="member__submit" type="submit" value="註冊新帳戶">
                </form>
                <div class="member__text--normal" id="signin_text">
                    <div class="member__text--success"></div>
                    <div class="member__text--error"></div>
                    <span>已經有帳戶了？</span>
                    <span class="member__text--pointer" onclick="signinPage(); return false">點此登入</span>
                </div>
            </div>

        </div>
        <script>
            let nextPage = 0;
            let keyword = '';
            let attractionsElem = document.querySelector('.attractions');
            let searchBtnElem = document.querySelector('.search_bar__button');
            let searchKeywordElem = document.querySelector('.search_bar__box');
            let leftArrowElem = document.querySelector('.list_bar__left_arrow');
            let rightArrowElem = document.querySelector('.list_bar__right_arrow');
            let containerElem = document.querySelector('.container');
            // 捲動顯示下一頁
            const callback = (entries) => {
                if(entries[0].isIntersecting && nextPage != null){
                    getAttractionsData(nextPage, keyword);
                    observer.unobserve(entries[0].target);
                }else if(nextPage == null){
                    observer.disconnect();
                };
            };
            const observer = new IntersectionObserver(callback);
            // 捷運清單捲動
            leftArrowElem.addEventListener('click', () => {
                containerElem.scrollLeft -= (containerElem.clientWidth-100);
            });
            rightArrowElem.addEventListener('click', () => {
                containerElem.scrollLeft += (containerElem.clientWidth-100);
            });
            // 捷運站清單按鈕
            function searchMrt(btn){
                searchKeywordElem.value = btn.textContent;
                searchBtnElem.click();
            };
            // 取得捷運列表
            (function getMrtsList(){
                fetch('/api/mrts').then(function(response){
                    return response.json();
                }).then(function(data){
                    for(let i=0; i<data['data'].length; i++){
                        if (data['data'][i] != 'None'){
                            let mrtButton = document.createElement('button');
                            mrtButton.className = 'list_item';
                            mrtButton.setAttribute('onclick', 'searchMrt(this)');
                            mrtButton.textContent = data['data'][i];
                            containerElem.appendChild(mrtButton);
                        };
                    };
                }).catch(function(error){
                    console.log(error['message']);
                });
            })();
            // 將取得的data渲染到畫面
            function renderAttractions(data){
                for(i=0; i<data['data'].length; i++){
                    let attractionBoxDiv = document.createElement('div');
                    attractionBoxDiv.className = 'attraction__box';
                    let attractionImg = document.createElement('img');
                    attractionImg.setAttribute('src',data['data'][i]['images'][0]);
                    let attractionNameDiv = document.createElement('div');
                    attractionNameDiv.className = 'attraction__name';
                    attractionNameDiv.textContent = data['data'][i]['name'];
                    let attractionDetailDiv = document.createElement('div');
                    attractionDetailDiv.className = 'attraction__detail';
                    let mrtDiv = document.createElement('div');
                    mrtDiv.textContent = data['data'][i]['mrt'];
                    let catDiv = document.createElement('div');
                    catDiv.textContent = data['data'][i]['category'];
                    let url = document.createElement('a');
                    url.setAttribute('href', `/attraction/${data['data'][i]['id']}`);
                    attractionDetailDiv.appendChild(mrtDiv);
                    attractionDetailDiv.appendChild(catDiv);
                    attractionBoxDiv.appendChild(attractionImg);
                    attractionBoxDiv.appendChild(attractionNameDiv);
                    attractionBoxDiv.appendChild(attractionDetailDiv);
                    url.appendChild(attractionBoxDiv);
                    attractionsElem.appendChild(url);
                };
            };
            // 取得景點DATA後渲染&無限捲動
            function getAttractionsData(page, keyword){
                fetch(`/api/attractions?page=${encodeURIComponent(page)}&keyword=${encodeURIComponent(keyword)}`).then(function(response){
                    return response.json();
                }).then(function(data){
                    nextPage = data['nextPage'];
                    if(data['data'].length == 0){
                        attractionsElem.textContent = '找不到相關的景點';
                    }else{
                        renderAttractions(data);
                        observer.observe(document.querySelector('.attractions').lastChild);
                    }
                }).catch(function(error){
                    console.log(error['message']);
                });
            };
            // 搜尋框按鈕
            searchBtnElem.addEventListener('click', function(e){
                e.preventDefault();
                keyword = searchKeywordElem.value;
                nextPage = 0;
                while (attractionsElem.hasChildNodes()){
                    attractionsElem.removeChild(attractionsElem.lastChild);
                };
                getAttractionsData(nextPage, keyword);
            });
            getAttractionsData(nextPage, keyword);

            // 清空登入/註冊頁面的提示訊息
            function clearReminder(){
                let successMessageElem = document.querySelector('.member__text--success');
                let errorMessageElem = document.querySelector('.member__text--error');
                successMessageElem.textContent = '';
                errorMessageElem.textContent = '';
            };
            // 開啟登入/註冊頁面
            function toggleSigninSignup(){
                let memberBackgroundElem = document.querySelector('.member__background');
                let memberContainerElem = document.querySelector('.member__container');
                memberBackgroundElem.classList.replace('member--hide', 'member--block');
                memberContainerElem.classList.replace('member--hide', 'member--block');
                clearReminder();
                signinPage();
            };
            // 關閉登入/註冊頁面
            function closeSigninSignup(){
                let memberBackgroundElem = document.querySelector('.member__background');
                let memberContainerElem = document.querySelector('.member__container');
                memberBackgroundElem.classList.replace('member--block', 'member--hide');
                memberContainerElem.classList.replace('member--block', 'member--hide');
            }
            // 切換到登入頁面
            function signinPage(){
                let memberTitleElem = document.querySelector('.member__title');
                let signinItemElem = document.querySelector('#signin_item');
                let signupItemElem = document.querySelector('#signup_item');
                memberTitleElem.textContent = '登入會員帳號';
                signinItemElem.className = 'member--block';
                signupItemElem.className = 'member--hide';
                clearReminder();
            };

            // 切換到註冊頁面
            function signupPage(){
                let memberTitleElem = document.querySelector('.member__title');
                let signinItemElem = document.querySelector('#signin_item');
                let signupItemElem = document.querySelector('#signup_item');
                memberTitleElem.textContent = '註冊會員帳號';
                signinItemElem.className = 'member--hide';
                signupItemElem.className = 'member--block';
                clearReminder();
            };
        </script>
    </body>
</html>